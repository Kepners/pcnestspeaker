<!DOCTYPE html>
<html>
<head>
  <title>PC Nest Speaker - Low Latency Receiver</title>
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <style>
    body {
      background: #334E58;
      margin: 0;
      padding: 0;
    }
    #status {
      color: #FCBFB7;
      font-family: sans-serif;
      font-size: 24px;
      text-align: center;
      padding-top: 40%;
    }
  </style>
</head>
<body>
  <cast-media-player></cast-media-player>
  <div id="status">PC Nest Speaker</div>

  <script>
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    // Configure for MINIMAL latency - optimized for MP3 progressive streams
    const playbackConfig = new cast.framework.PlaybackConfig();

    // Start playback with minimal buffer (works for MP3)
    playbackConfig.autoResumeDuration = 0.1;  // Start after just 0.1s of buffer
    playbackConfig.autoPauseDuration = 0.05;  // Only pause if buffer drops to 50ms

    // High bandwidth estimate = no bandwidth probing delay
    playbackConfig.initialBandwidth = 10000000; // 10 Mbps

    // Disable preloading to reduce startup delay
    playbackConfig.disablePreload = true;

    // For HLS streams (if used), also set Shaka config
    playbackConfig.shakaConfig = {
      streaming: {
        bufferingGoal: 0.5,        // Only buffer 0.5 seconds ahead
        rebufferingGoal: 0.1,      // Resume after 0.1s buffered
        bufferBehind: 1,           // Keep 1s behind
        lowLatencyMode: true,
        segmentPrefetchLimit: 0,   // Don't prefetch
      }
    };

    // Intercept load requests to force LIVE stream type for minimal buffering
    playerManager.setMessageInterceptor(
      cast.framework.messages.MessageType.LOAD,
      (loadRequestData) => {
        console.log('Load intercepted, forcing LIVE mode');
        if (loadRequestData.media) {
          loadRequestData.media.streamType = cast.framework.messages.StreamType.LIVE;
        }
        return loadRequestData;
      }
    );

    // Set the playback config
    playerManager.setPlaybackConfig(playbackConfig);

    // Log events for debugging
    playerManager.addEventListener(
      cast.framework.events.EventType.PLAYER_LOADING,
      (event) => console.log('Loading media...')
    );

    playerManager.addEventListener(
      cast.framework.events.EventType.BUFFERING,
      (event) => console.log('Buffering:', event.isBuffering)
    );

    playerManager.addEventListener(
      cast.framework.events.EventType.PLAYING,
      (event) => console.log('Playing!')
    );

    playerManager.addEventListener(
      cast.framework.events.EventType.ERROR,
      (event) => console.log('Error:', event.detailedErrorCode)
    );

    // Start the receiver with minimal options
    context.start({
      playbackConfig: playbackConfig,
      skipPlayersLoad: false,
      supportedCommands: cast.framework.messages.Command.ALL_BASIC_MEDIA
    });

    console.log('PC Nest Speaker receiver started - MP3 low-latency mode');
  </script>
</body>
</html>
